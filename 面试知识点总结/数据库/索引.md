## 什么是索引

**索引是一种用于快速查询和检索数据的数据结构。常见的索引结构有: B树， B+树和Hash。**

索引的作用就相当于目录的作用。快速定位数据在哪一页

### Hash索引和B+树索引优劣分析

Hash索引指的是Hash表，利用Hash函数，能够很快定位数据的位置，这是B+树不能比的

使用Hash表一个问题就是Hash冲突问题

Hash索引不支持顺序和范围查询，这是他的最大的问题。

### 索引的优点

- 大大加快数据的检索速度
- 通过创建唯一性索引，保证数据表中每一行数据的唯一性

### 索引的缺点

1. 创建索引和维护索引需耗费许多时间：对数据增删改查，如果数据有索引的话，索引需要动态修改，会降低sql的执行效率
2. 占用物理存储空间：索引使用物理文件存储

## B+树

### B树

B 树就是常说的“B 减树（B- 树）”，又名平衡多路（即不止两个子树）查找树

1. 平衡二叉树节点最多有两个子树，而 B 树每个节点可以有多个子树，**M 阶 B 树表示该树每个节点最多有 M 个子树**
2. 平衡二叉树每个节点只有一个数据和两个指向孩子的指针，而 B 树每个**中间节点**有 k-1 个关键字（可以理解为数据）和 k 个子树（ **k 介于阶数 M 和 M/2 之间，M/2 向上取整）
3. B 树的所有叶子节点都在同一层，并且叶子节点只有关键字，指向孩子的指针为 null

### B 树中如何查找数据

因为 B 树的子树大小排序规则，因此在 B 树中查找数据时，一般需要这样：

1. 从根节点开始，如果查找的数据比根节点小，就去左子树找，否则去右子树
2. 和子树的多个关键字进行比较，找到它所处的范围，然后去范围对应的子树中继续查找
3. 以此循环，直到找到或者到叶子节点还没找到为止

### B+树

B+ Tree 是基于 B Tree 和叶子节点顺序访问指针进行实现，它具有 B Tree 的平衡性，并且通过顺序访问指针来提高区间查询的性能。

### 选择B+树而不选择红黑树的原因

- B+树有更低的树高

  红黑树的出度为2，B+树的初读一般比较打，因此高度低

- 磁盘访问原理

  操作系统一般将内存和磁盘分割成固定大小的块，每一块称为一页，内存与磁盘以页为单位交换数据。数据库系统将索引的一个节点的大小设置为页的大小

- 磁盘预读特性

  为了减少磁盘 I/O 操作，磁盘往往不是严格按需读取，而是每次都会预读。预读为顺序读取，不需要磁盘寻道，速度很快，相邻的节点会被预先载入。

## 索引类型

### 主键索引

数据库表的主键列使用的就是主键索引。

一张表只能有一个主键，并且主键不能为null，不能重复。

没有明确指定主键的话，InnoDB会自动创建一个6Byte的自增主键。

### 二级索引(辅助索引)

主键索引存储所有需要查询的字段值，辅助索引索引存储的是索引列和主键值

唯一索引，普通索引，前缀索引等属于辅助索引

- 唯一索引：索引列不能出现重复值，允许数据为null，一张表允许创建多个唯一索引列
- 普通索引：普通索引，允许出现重复之和null，作用：加快数据查询
- 前缀索引
  - 联合索引前缀，无法跨越字段使用联合索引，联合索引前缀对于索引片的过滤只能到第一个使用非等值条件的字段为止
  - like前缀
  - 字符串前缀（使用字符串前几个字符作为索引）

## 聚簇索引和非聚簇索引

### 聚簇索引

聚簇索引即索引结构和数据一起存放的索引，**主键索引属于聚集索引**

在 Mysql 中，InnoDB引擎的表的 `.ibd`文件就包含了该表的索引和数据，非叶子节点存储索引，叶子节点存储索引和索引对应的数据

**优点：**

查询速度快

**缺点：**

1. 依赖有序的数据。顺序插入时很快的，否则就会出现页分裂（保证有序，移动），严重影响性能，所以我们一般保证主键是自增的
2. 更新代价大，会导致更新的行移动。一般定义主键是不可更新的

### 非聚簇索引

非聚簇索引即索引结构和数据分开存放的索引，二级索引就属于非聚簇索引

> MYISAM引擎的表的.MYI文件包含了表的索引， 该表的索引(B+树)的每个叶子非叶子节点存储索引， 叶子节点存储索引和索引对应数据的指针，指向.MYD文件的数据。

**优点：**

更新代价比聚簇索引小

**缺点：**

1. 依赖于有序的数据

2. 回表

   非聚簇索引叶子节点存储索引列和主键，如果查询的数据非以上这些，就需要依靠查询到的主键值到主键索引上再次查询。

## 覆盖索引

**覆盖索引即需要查询的字段正好是索引的字段，那么直接根据该索引，就可以查到数据了， 而无需回表查询。**

## 索引创建的原则

### 最左前缀原则

联合索引需要先遵循最左前缀匹配原则，即从联合索引最左边开始匹配

无法跨越字段使用联合索引，联合索引前缀对于索引片的过滤只能到第一个使用非等值条件的字段为止

### 选择合适的字段

1. 不为null的字段
2. 被频繁查询的字段
3. 被作为条件查询的字段
4. 被经常频繁用于连接的字段

> **连接：**
>
> - 内连接
>   1. 选取驱动表，使用与驱动表相关的过滤条件，选取代价最低的单表访问方法执行驱动表的单表查询
>   2. 查询结果集中的每一条记录，到被驱动表中查询匹配的记录。
> - 右连接
> - 左连接
>
> **嵌套循环连接**
>
> 驱动表只访问一次，但被驱动表却可能被多次访问，访问次数取决于对驱动表执行单表查询后的结果集中的记录条数
>
> **使用索引加快连接速度**
>
> 驱动表中查询后的结果集，在到被驱动表访问时可以尽量使用索引来加快查询速度。
>
> **基于块的嵌套循环连接**
>
> 对于结果集，放在join buffer中，批量和被驱动表做匹配。
>
> 减少被驱动表访问次数，减少I/O代价