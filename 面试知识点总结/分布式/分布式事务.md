指事务的操作位于不同的服务节点上，需要保证事物的ACID特性

例如下单场景，库存和订单如果不在同一个节点上，这就涉及分布式事务。

### CAP

数据库的ACID四大特性已经不能满足分布式事务

- C(一致性)：每个节点读操作返回的数据都是一致的
- A(可用性)：非故障的节点在合理的时间内返回合理的响应
- P(分区容错性)：出现网络分区后（例如某个机器网络出现问题），系统能够继续工作

### 分布式事务的解决方案

#### 2PC

- 第一阶段：协调者询问参与者事务是否执行成功，参与者发回事务执行结果。
- 第二阶段：如果事务在每个参与者上都执行成功，事务协调者发送通知让参与者提交事务，否则，协调者发送通知让参与者回滚事务。

尽量保证数据强一致

缺点：

- 单点问题：协调者在 2PC 中起到非常大的作用，发生故障将会造成很大影响
- 同步阻塞：所有事务参与者在等待其它参与者响应的时候都处于同步阻塞等待状态
- 数据不一致：第二阶段，因网络问题出现节点未收到commit操作，则数据不一致

#### 3PC

**阶段一：CanCommit**

1. 事务询问：协调者向参与者发送包含事务的CanCommit，
2. 参与者反馈询问响应

**阶段二：PreCommit**

协调者收到所有参与者的ack，则执行事务预提交：

协调者向参与者发出PreCommit请求并进入prepare阶段

参与者接收到PreCommit请求后，执行事务操作，返回事务执行结果



中断事务：阶段一若有no反馈，或者与协调者通讯超时，则执行事务中断操作

> 事务中断操作：
>
> 协调者发送abort请求，参与者接收到abort请求后执行事务中断操作

**阶段三：DoCommit**

协调者从上一阶段获取所有参与者的ack返回后，执行事务最终提交：

协调者发出DoCommit请求，参与者接受到之后执行事务提交请求，释放事务资源

反馈提交结果



中断事务：有任一参与者反馈 No，或者在等待超时后无法接收所有参与者的反馈，都会中断事务

协调者发送abort请求，参与者接收到abort请求后Rollback，并在回滚后释放资源

参与者反馈事务回滚结果，协调者接收到整个事务回滚结果后，中断整个事务

**阶段三中任何参与者等待协调者请求超时均会提交事务**

**3PC增加了超时机制，当参与者等待协调者请求超时，则中断事务**

3PC提高了效率，却没有保证数据强一致性。

> 在`PreCommit`消息发送后，如果协调者和某个参与者无法正常通信，由于没有接收到整个参与者的反馈，则会执行中断事务，然而该参与者会提交事务，会造成数据不一致

#### Paxos

##### 三种角色

- 倡议者（Proposer）：提出提案[n，v],用于投票表决，一般来说，集群中收到客户端请求的节点，就是提议者
- 接收者（Acceptor）：Acceptor， 对每个提案进行投票，并存储接受的值。
- 学习者（Learner）：不参与投票， 被告知投票的结果

##### 阶段一（准备阶段）

Proposer向所有的Acceptor广播Prepare请求，Prepare请求仅仅是提案序号**SN1**

Acceptor接收到Prepare请求**SN1**后，检查自身上次回复过的Prepare请求**SN2**
①：如果之前没有进行过任何Prepare请求的响应，则简单回复；
②：如果**SN1≤SN2**，则忽略此请求，直接结束本次批准过程；
③：如果 **SN1≥SN2**，检查上次接受过的提议**[SNx，Vx]**，并回复**[SNx，Vx]**

##### 阶段二（批准阶段）

1. 经过一段时间后，Proposer收到一些Acceptor回复，回复可分为以下几种情况：
   ①：若回复数量多于半数**（N/2+1）**，并所有的回复都是`<OK>`，则Porposer发起自己的提案accept请求，请求内容为 **[SN1, V1]**（V1随意取值）；
   ②：若回复数量多于半数**（N/2+1）**，但有的回复为：[SN2，V2]，[SN3，V3]…… 则Porposer找到所有回复中序号最大的那个，假设为 **[SNx，Vx]**，然后发起accept请求，请求内容为提案 **[SN1，Vx]**；
   ③：若回复数量少于半数，则Proposer尝试将提案序号自增1**（SN1+1=SN2）**，转【阶段一（准备阶段）】继续执行；

1. Acceptor接收到accept请求 **[SN1，Vx]**后，只要该Acceptor**尚未响应过任何编号大于SN1的Prepare请求**，它就接受该提案，然后响应`<ok>`；
2. Proposer收到超过半数的`<ok>`响应后，将提案最终结果通知给Learner；否则，将提案序号自增1，转【阶段一（准备阶段）】继续执行。