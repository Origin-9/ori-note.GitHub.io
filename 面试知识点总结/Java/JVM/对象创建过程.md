### 对象的内存布局

在 Hotspot 虚拟机中，对象在内存中的布局可以分为 3 块区域：**对象头**、**实例数据**和**对齐填充**。

**Hotspot 虚拟机的对象头包括两部分信息**，**第一部分用于存储对象自身的运行时数据**（哈希码、GC 分代年龄、锁状态标志等等），**另一部分是类型指针**，即对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是那个类的实例。

**实例数据部分是对象真正存储的有效信息**，也是在程序中所定义的各种类型的字段内容。

**对齐填充部分不是必然存在的，也没有什么特别的含义，仅仅起占位作用。** 

### 对象的创建

![image-20200824160857010](C:\Users\Ori\AppData\Roaming\Typora\typora-user-images\image-20200824160857010.png)

#### 1. 类加载检查

虚拟机遇到一条 new 指令时，首先去检查这个指令的参数是否能在常量池中定位到这个类的符号引用，并且检查这个符号引用代表的类是否已被加载过、解析和初始化过。如果没有，那必须先执行相应的类加载过程。

#### 2. 分配内存

在**类加载检查**通过后，接下来虚拟机将为新生对象**分配内存**。**分配方式**有 **“指针碰撞”** 和 **“空闲列表”** 两种

![image-20200824161145970](C:\Users\Ori\AppData\Roaming\Typora\typora-user-images\image-20200824161145970.png)

#### 3. 初始化零值

内存分配完成后，虚拟机需要将分配到的内存空间都初始化为零值

#### 4. 设置对象头

初始化零值完成之后，**虚拟机要对对象进行必要的设置**

#### 5. 执行init方法

从虚拟机的视角来看，一个新的对象已经产生了，但从 Java 程序的视角来看，对象创建才刚开始。

执行 new 指令之后会接着执行 `<init>` 方法（构造方法）。

### 对象的访问定位

Java 程序通过栈上的 reference 数据来操作堆上的具体对象，访问方式有**①使用句柄**和**②直接指针**两种

- 句柄：Java 堆中将会划分出一块内存来作为句柄池，reference 中存储的就是对象的句柄地址，而句柄中包含了对象实例数据与类型数据各自的具体地址信息；
- 直接指针：reference 中存储的直接就是对象的地址。![image-20200824161732281](C:\Users\Ori\AppData\Roaming\Typora\typora-user-images\image-20200824161732281.png)

句柄稳定，对象移动，只需要修改句柄中实例数据指针，reference无需修改；直接指针速度快，